<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta content="width=device-width, initial-scale=1">
   <title>ä½ ç”µå›¾ä¹¦ç®¡ç†ç³»ç»Ÿ</title>
   <link rel="stylesheet" type="text/css" href="./css/login.css">
   <link rel="stylesheet" href="./css/navigation.css">
   <style>
      body {
         font-family: Arial, sans-serif;
         margin: 0;
         padding: 0;
      }
   </style>
<style>
.order-list-container {
  width: 90%;
  margin: 20px auto;
}

.order-list-container table {
  table-layout: fixed;
  width: 100%;
  border-collapse: collapse;
  background-color: #fff;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.order-list-container thead {
  color: black;
}

.order-list-container th, td {
  text-align: center;
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
  padding: 10px;
  border: 1px solid #ddd;
}

.order-list-container tr:hover {
  background-color: #f2f2f2;
}

button {
  padding: 5px 10px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.order-list-container button.accept {
  background-color: green;
  color: white;
}

.order-list-container button.refuse {
  background-color: red;
  color: white;
}

</style>
</head>

<body>

   <!-- header -->

   <h1 style="text-align: center"> æ¬¢è¿ä½¿ç”¨ è®¢å•ç®¡ç†ï¼</h1>

   <div class="order-list-container">
      <table>
         <colgroup>
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 5%;">
            <col style="width: 5%;">
         </colgroup>
         <thead>
            <tr>
               <th>è®¢å•å·</th>
               <th>ä¹¦å</th>
               <th>ISBN</th>
               <th>å‡ºç‰ˆç¤¾</th>
               <th>ä½œè€…</th>
               <th>è®¢è´­æ•°</th>
               <th>éªŒæ”¶</th>
               <th>é€€è´§</th>
            </tr>
         </thead>
         <tbody id="order-list">
            <!-- å€Ÿé˜…ä¿¡æ¯å°†é€šè¿‡ JavaScript åŠ¨æ€æ’å…¥ -->
         </tbody>
      </table>
   </div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
   try {
      const res = await fetch('/api/order/getAll');

      if (res.ok) {
         const result = await res.json();
         console.log('è·å–æˆåŠŸ', result);

         const orderList = document.getElementById('order-list');
         result.forEach(order => {
            const row = document.createElement('tr');
            row.setAttribute('data-Ordernum', order.Ordernum);

            row.innerHTML = `
               <td>${order.Ordernum}</td>
               <td>${order.bookTitle}</td>
               <td>${order.ISBN}</td>
               <td>${order.Press}</td>
               <td>${order.author}</td>
               <td>${order.orderbookNum}</td>
               <td>
                  <button class="accept">éªŒæ”¶</button>
               </td>
               <td>
                  <button class="refuse">é€€è´§</button>
               </td>
            `;
            orderList.appendChild(row);
         });

      } else {
         console.log('è·å–å¤±è´¥');
      }
   } catch (err) {
      console.error('è¯·æ±‚å‡ºé”™', err);
   }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
   console.log('é¡µé¢åŠ è½½å®Œæˆ - å¼€å§‹æ‰§è¡Œ');
   const table = document.querySelector('#order-list');
   console.log('æ‰¾åˆ°è¡¨æ ¼ï¼Œå¼€å§‹ç»‘å®šäº‹ä»¶');

   table.addEventListener('click', async (event) => {
      if (event.target.classList.contains('accept')) {
         console.log('ç‚¹å‡»äº†éªŒæ”¶æŒ‰é”®');

         const tr = event.target.closest('tr');

         const Ordernum = tr.getAttribute('data-Ordernum');
         const username = localStorage.getItem('username');

         // è®¡ç®—å®é™…æ—¥æœŸ
         const returnDateStr = new Date().toISOString().split('T')[0];
         let returnDate = new Date(returnDateStr);

         try {
            const response = await fetch('/api_zhao/dingdanyanshou', { // éªŒæ”¶api
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
               },
               body: JSON.stringify({
                  // æˆ‘åœ¨è¿™é‡Œç”¨ä½ é¢„æœŸçš„å­—æ®µä¼ è¾“äº†ä½ éœ€è¦çš„ä¿¡æ¯
                  Ordernum: Ordernum,
                  acceptMan: username,
                  acceptTime: returnDate.toISOString().split('T')[0],
               }),
            });

            console.log('Ordernum: ' + Ordernum);
            console.log('acceptMan: ' + username);
            console.log('acceptTime: ' + returnDate.toISOString().split('T')[0]);

            if (response.ok) {
               const result = await response.json();
               console.log('éªŒæ”¶æˆåŠŸ:', result);
               alert(`éªŒæ”¶æˆåŠŸğŸ˜Š: ${result.message}`);
            } else {
               const result = await response.json();
               console.error('éªŒæ”¶å¤±è´¥:', result);
               alert(`éªŒæ”¶å¤±è´¥\u{1f623} ${result.message}`);
            }
         } catch (error) {
            console.error('è¯·æ±‚å‡ºé”™:', error);
            alert('éªŒæ”¶æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
         } finally {
            window.location.reload();
         }
      }
   });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
   console.log('é¡µé¢åŠ è½½å®Œæˆ - å¼€å§‹æ‰§è¡Œ');
   const table = document.querySelector('#order-list');
   console.log('æ‰¾åˆ°è¡¨æ ¼ï¼Œå¼€å§‹ç»‘å®šäº‹ä»¶');

   table.addEventListener('click', async (event) => {
      if (event.target.classList.contains('refuse')) {
         console.log('ç‚¹å‡»äº†é€€è´§æŒ‰é”®');

         const tr = event.target.closest('tr');

         const Ordernum = tr.getAttribute('data-Ordernum');

         // è®¡ç®—å®é™…æ—¥æœŸ
         const returnDateStr = new Date().toISOString().split('T')[0];
         let returnDate = new Date(returnDateStr);

         try {
            const response = await fetch('/api_zhao/dingdantuihuo', { // é€€è´§api
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
               },
               body: JSON.stringify({
                  // æˆ‘åœ¨è¿™é‡Œç”¨ä½ é¢„æœŸçš„å­—æ®µä¼ è¾“äº†ä½ éœ€è¦çš„ä¿¡æ¯
                  Ordernum: Ordernum,
                  returnTime: returnDate.toISOString().split('T')[0],
                  returnReason: "7å¤©æ— ç†ç”±",
               }),
            });

            console.log('Ordernum: ' + Ordernum);
            console.log('returnReason: ' + returnDate.toISOString().split('T')[0]);

            if (response.ok) {
               const result = await response.json();
               console.log('é€€è´§æˆåŠŸ:', result);
               alert(`é€€è´§æˆåŠŸğŸ˜Š: ${result.message}`);
            } else {
               const result = await response.json();
               console.error('é€€è´§å¤±è´¥:', result);
               alert(`é€€è´§å¤±è´¥\u{1f623} ${result.message}`);
            }
         } catch (error) {
            console.error('è¯·æ±‚å‡ºé”™:', error);
            alert('é€€è´§æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
         } finally {
            window.location.reload();
         }
      }
   });
});
</script>

</body>
</html>
